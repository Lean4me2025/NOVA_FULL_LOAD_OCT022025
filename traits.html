
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NOVA Â· Select Your Traits</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
</head>
<body>
  <div class="wrap">
    <h1>Select Your Traits</h1>
    <p class="sub">Tap to select up to <b>12</b>. You can change your mind.</p>
    <p class="small" id="catLine"></p>
    <div id="grid" class="grid" role="list"></div>
    <div class="bar">
      <div class="caption" id="cap">0 / 12 selected</div>
      <button id="next" class="btn" disabled>Next: Role Reveal</button>
    </div>
  </div>
  <script type="module">
    import { readJSON, getSelectedCategories, setSelectedTraits, dedupe, byAlpha } from './assets/js/shared.js';
    const MAX = 12;
    const grid = document.getElementById('grid');
    const cap  = document.getElementById('cap');
    const catLine = document.getElementById('catLine');
    let selected = new Set();

    function update(){
      cap.textContent = `${selected.size} / ${MAX} selected`;
      document.getElementById('next').disabled = selected.size===0;
      setSelectedTraits([...selected]);
    }

    function render(list){
      grid.innerHTML='';
      list.forEach(trait=>{
        const el=document.createElement('div');
        el.className='pill';
        el.textContent=trait;
        el.addEventListener('click',()=>{
          if(selected.has(trait)) { selected.delete(trait); el.classList.remove('selected'); update(); return; }
          if(selected.size>=MAX) return;
          selected.add(trait);
          el.classList.add('selected');
          update();
        });
        grid.appendChild(el);
      });
      update();
    }

    const cats = getSelectedCategories();
    catLine.textContent = cats.length ? `From categories: ${cats.join(', ')}` : 'No categories chosen.';

    readJSON('data/traits_with_categories.json').then(map=>{
      const bag = [];
      cats.forEach(c=>{
        if (map[c]) bag.push(...map[c]);
        else {
          // case-insensitive fallback
          const k = Object.keys(map).find(k=>k.toLowerCase()===c.toLowerCase());
          if (k) bag.push(...map[k]);
        }
      });
      const list = dedupe(bag).sort(byAlpha);
      render(list);
    }).catch(e=>{
      console.error('Failed to load traits JSON', e);
      grid.innerHTML = '<div class="card">Could not load traits. Check data/traits_with_categories.json path.</div>';
    });

    document.getElementById('next').addEventListener('click',()=>location.href='role.html');
  </script>
</body>
</html>
